import Head from 'next/head'
import Link from 'next/link'
import React, { useEffect, useState } from 'react'
import styled from 'styled-components'

import { Nav } from '../components/Nav'
import { Searchbar } from '../components/Searchbar'
import { RecipeList } from '../components/RecipeList'
import { FiltersWrapper } from '../components/FiltersWrapper'

import { GetRecipesQuery, Recipe, Tag } from '../server/interfaces'
import { useGetRecipes } from '../hooks/useGetRecipes'
import { useDebounce } from '../hooks/useDebounce'

export default function Home() {
	const [recipeArray, setRecipeArray] = useState<Recipe[]>([])
	const [query, setQuery] = useState<GetRecipesQuery>()
	const [searchString, setSearchString] = useState()
	//move down a layer?
	const [filters, setFilters] = useState<Tag[]>([])

	const { getRecipes } = useGetRecipes()
	const searchbarOnSearch = useDebounce(setSearchString, 200)

	useEffect(() => {
		getRecipes(query).then(recipes => {
			setRecipeArray(recipes)
		})
	}, [query])

	useEffect(() => {
		let filterString
		if (filters) {
			filterString = filters.map(tag => tag.tag_name)
		}
		setQuery({ name: searchString, filters: filterString })
	}, [searchString, filters])

	return (
		<>
			<Head>
				<title>Recipes</title>
				<meta name='description' content='Generated by create next app' />
				<link rel='icon' href='/favicon.ico' />
			</Head>
			<Main>
				<Nav>
					<Searchbar onSearch={searchbarOnSearch} />
					<Link href={`/newrecipe`}>
						<Button>New Recipe</Button>
					</Link>
				</Nav>
				<FiltersWrapper onSubmit={setFilters} />
				{recipeArray && <RecipeList recipesToRender={recipeArray} />}
			</Main>
		</>
	)
}

const Main = styled.main`
	position: relative;
	min-height: 100vh;
	display: flex;
	flex-direction: column;
	align-items: center;
	background-color: ${p => p.theme.color.gamma};
`

const Button = styled.button`
	cursor: pointer;
	font: 700 2rem ${p => p.theme.font.title};
	line-height: 2rem;
	padding: 0.5rem 2rem;
	color: ${p => p.theme.color.delta};
	border: 2px solid ${p => p.theme.color.delta};
	background-color: ${p => p.theme.color.white};
	transition: 0.2s;
	&:hover {
		color: ${p => p.theme.color.white};
		background-color: ${p => p.theme.color.delta};
	}
`
